<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DAS PROVI â€” Final (Angka saja)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f4f7fb; --card:#fff; --primary:#0a58a6; --accent:#007bff; --muted:#6b7280;
      --radius:10px; --shadow: 0 8px 24px rgba(12,40,80,0.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Poppins,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#0b1720}
    .container{max-width:1200px;margin:18px auto;padding:18px}
    .top{display:flex;flex-direction:column;gap:12px;margin-bottom:12px}
    .cards{display:flex;gap:10px;flex-wrap:wrap}
    .card{background:var(--card);border-radius:10px;padding:12px 14px;box-shadow:var(--shadow);min-width:110px;text-align:center}
    .card .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .card .value{font-size:18px;font-weight:700;color:var(--primary)}
    .controls{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .search{display:flex;align-items:center;background:#f5f7fb;border-radius:10px;padding:6px 8px}
    .search input{border:0;background:transparent;outline:none;padding:6px 8px;min-width:200px}
    button.btn{background:var(--primary);color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    .error{display:none;background:#fff4f6;color:#b91c1c;padding:10px;border-radius:8px;margin-bottom:8px}
    .table-wrap{overflow:auto;border-radius:8px;background:var(--card);box-shadow:var(--shadow);padding:12px}
    table{width:100%;border-collapse:collapse;min-width:900px}
    thead th{position:sticky;top:0;padding:10px;background:linear-gradient(180deg,var(--accent),var(--primary));color:#fff;text-transform:uppercase;font-size:12px}
    tbody td{padding:10px;border-bottom:1px solid #eef2f7;text-align:center;font-size:13px}
    tbody tr:hover{background:#f7fbff}
    td.clickable{cursor:pointer}
    td.sisa{font-weight:700;color:var(--primary)}
    tfoot td{padding:10px;border-top:2px solid #e6eefc;font-weight:700;text-align:center}
    #detailContainer{margin-top:12px;display:none;background:var(--card);padding:12px;border-radius:10px;box-shadow:var(--shadow)}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(10,20,40,0.18);visibility:hidden;opacity:0;transition:all .18s;z-index:9999}
    .overlay.active{visibility:visible;opacity:1}
    .spinner{width:56px;height:56px;border-radius:50%;border:6px solid rgba(255,255,255,0.16);border-top-color:#fff;animation:spin 1s linear infinite;background:var(--primary);padding:6px}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:900px){ .search input{min-width:140px} table{min-width:700px} .cards{justify-content:flex-start} }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <h2 style="margin:0;font-size:18px">DAS PROVI â€” Angka</h2>
          <div style="color:var(--muted);font-size:13px;margin-top:6px">SISA WO = AO + MO + SURVEY + TARIK DC + BAI - PS + KENDALA</div>
        </div>
        <div class="controls">
          <div class="search" title="Search detail">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:.8"><path d="M21 21l-4.35-4.35" stroke="#6b7280" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <input id="searchDetail" placeholder="Cari di detail (ketik bebas)..." aria-label="search" />
          </div>
          <button id="refreshBtn" class="btn">ðŸ”„ Refresh</button>
        </div>
      </div>

      <div class="cards" id="summaryCards" aria-hidden="false">
        <!-- Numeric cards injected here -->
      </div>
    </div>

    <div id="errorBox" class="error" role="alert"></div>

    <div class="table-wrap" aria-live="polite">
      <table id="mainTable" role="table" aria-label="Tabel Sisa WO">
        <thead><tr>
          <th>Teknisi</th>
          <th>AO</th>
          <th>MO</th>
          <th>Survey</th>
          <th>Tarik DC</th>
          <th>BAI</th>
          <th>PS</th>
          <th>Kendala</th>
          <th>SISA WO</th>
        </tr></thead>
        <tbody></tbody>
        <tfoot></tfoot>
      </table>
    </div>

    <div id="detailContainer" aria-live="polite">
      <h3 style="margin-top:0">Detail Data</h3>
      <div style="overflow:auto;max-height:360px">
        <table id="detailTable"><thead></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay"><div class="spinner" role="status" aria-label="loading"></div></div>

  <script>
  // ================== CONFIG ==================
  const SHEET_MAIN = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQlp8lhcVisWxG9C5IwSDAtyJ1J9o5WwJWAiLMLutD7XI-G6VRh4IipiVkJQnFHXtigs9m2JhKaBD9B/pub?gid=1651389267&single=true&output=csv";
  const SHEET_PROVI = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQlp8lhcVisWxG9C5IwSDAtyJ1J9o5WwJWAiLMLutD7XI-G6VRh4IipiVkJQnFHXtigs9m2JhKaBD9B/pub?gid=1451848426&single=true&output=csv";
  const AUTO_REFRESH_MS = 60 * 1000; // 1 minute
  const FETCH_TIMEOUT_MS = 15000; // 15s

  // ================== STATE ==================
  let cacheMain = null;
  let cacheProvi = null;
  let autoRefreshTimer = null;

  const overlay = document.getElementById('overlay');
  const errorBox = document.getElementById('errorBox');
  const mainTbody = document.querySelector('#mainTable tbody');
  const mainTfoot = document.querySelector('#mainTable tfoot');
  const detailContainer = document.getElementById('detailContainer');
  const detailThead = document.querySelector('#detailTable thead');
  const detailTbody = document.querySelector('#detailTable tbody');
  const summaryCards = document.getElementById('summaryCards');

  // Helpers
  function showLoading(){ overlay.classList.add('active') }
  function hideLoading(){ overlay.classList.remove('active') }
  function showError(msg, hideAfterMs=8000){ errorBox.style.display='block'; errorBox.textContent = msg; if (hideAfterMs) setTimeout(()=> errorBox.style.display='none', hideAfterMs); }
  function clearError(){ errorBox.style.display='none'; errorBox.textContent = '' }

  function parseNumber(v){
    if (v === null || v === undefined) return 0;
    const s = String(v).replace(/[^0-9.-]+/g,'');
    // digit-by-digit safe parse
    let sign = 1;
    let str = s;
    if (str.startsWith('-')){ sign = -1; str = str.slice(1); }
    // remove leading zeros
    str = str.replace(/^0+(?=\d)/, '');
    const n = parseFloat(str);
    return isNaN(n) ? 0 : n * sign;
  }

  // Fetch with timeout and fallback proxy
  async function fetchWithTimeout(url, opts = {}){
    const controller = new AbortController();
    const id = setTimeout(()=> controller.abort(), FETCH_TIMEOUT_MS);
    try{
      const r = await fetch(url, { signal: controller.signal, ...opts });
      clearTimeout(id);
      return r;
    }catch(err){
      clearTimeout(id);
      throw err;
    }
  }

  async function fetchCSV(url){
    if (typeof navigator !== 'undefined' && !navigator.onLine) throw new Error('Offline: periksa koneksi internet.');
    try{
      const res = await fetchWithTimeout(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      return Papa.parse(text.trim(), { header: false, skipEmptyLines: true }).data;
    }catch(err){
      // fallback proxy
      try{
        const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
        const res2 = await fetchWithTimeout(proxy, { cache: 'no-store' });
        if (!res2.ok) throw new Error('Proxy HTTP ' + res2.status);
        const text2 = await res2.text();
        return Papa.parse(text2.trim(), { header: false, skipEmptyLines: true }).data;
      }catch(proxyErr){
        throw new Error('Gagal unduh CSV. Pastikan Google Sheet sudah \"Publish to web\" (CSV) dan dapat diakses. Details: ' + (proxyErr.message || proxyErr));
      }
    }
  }

  // find header index helper (case-insensitive, partial)
  function findIndexByCandidates(headers, candidates){
    if (!headers) return -1;
    const lower = headers.map(h => (h||'').toString().toLowerCase());
    for (const cand of candidates){
      const c = cand.toLowerCase();
      for (let i=0;i<lower.length;i++){
        if (lower[i].includes(c) || c.includes(lower[i])) return i;
      }
    }
    return -1;
  }

  // Build numeric summary cards
  function renderSummaryCards(totals){
    const order = [
      {k:'AO', label:'AO'},
      {k:'MO', label:'MO'},
      {k:'Survey', label:'Survey'},
      {k:'Tarik', label:'Tarik DC'},
      {k:'BAI', label:'BAI'},
      {k:'PS', label:'PS'},
      {k:'Kendala', label:'Kendala'},
      {k:'Sisa', label:'SISA WO'}
    ];
    summaryCards.innerHTML = '';
    order.forEach(o=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<div class="label">${o.label}</div><div class="value">${totals[o.k] ?? 0}</div>`;
      summaryCards.appendChild(card);
    });
  }

  // Compute SISA WO according to final formula for a given row and index map
  function computeSisaWOFromRow(row, idx){
    const AO = parseNumber(row[idx.AO]);
    const MO = parseNumber(row[idx.MO]);
    const Survey = parseNumber(row[idx.Survey]);
    const Tarik = parseNumber(row[idx.Tarik]);
    const BAI = parseNumber(row[idx.BAI]);
    const PS = parseNumber(row[idx.PS]);
    const Kendala = parseNumber(row[idx.Kendala]);
    return AO + MO + Survey + Tarik + BAI - PS + Kendala;
  }

  // Load & render main table
  async function loadMainTable(){
    clearError();
    showLoading();
    try{
      if (typeof Papa === 'undefined') throw new Error('Library PapaParse belum dimuat.');
      const [dataMain, dataProvi] = await Promise.all([fetchCSV(SHEET_MAIN), fetchCSV(SHEET_PROVI)]);
      cacheMain = dataMain;
      cacheProvi = dataProvi;

      // Use rows 3..18 and columns C..M like original (adjust if different)
      const rawRows = cacheMain.slice(2, 18);
      const sliced = rawRows.map(r => r.slice(2, 13)); // C..M
      if (!sliced || sliced.length === 0) throw new Error('CSV utama kosong atau format tidak sesuai.');

      const headers = sliced[0].map(h => h || '');
      const bodyRows = sliced.slice(1);

      // detect indices by header name; fallback to prior known positions
      const idx = {
        Teknisi: findIndexByCandidates(headers, ['teknisi','nama teknisi','nama']) >= 0 ? findIndexByCandidates(headers, ['teknisi','nama teknisi','nama']) : 0,
        AO: findIndexByCandidates(headers, ['ao','a.o']) >= 0 ? findIndexByCandidates(headers, ['ao','a.o']) : 1,
        MO: findIndexByCandidates(headers, ['mo']) >= 0 ? findIndexByCandidates(headers, ['mo']) : 2,
        Survey: findIndexByCandidates(headers, ['survey']) >= 0 ? findIndexByCandidates(headers, ['survey']) : 5,
        Tarik: findIndexByCandidates(headers, ['tarik dc','tarik_dc','tarik']) >= 0 ? findIndexByCandidates(headers, ['tarik dc','tarik_dc','tarik']) : 6,
        BAI: findIndexByCandidates(headers, ['bai']) >= 0 ? findIndexByCandidates(headers, ['bai']) : 7,
        PS: findIndexByCandidates(headers, ['ps']) >= 0 ? findIndexByCandidates(headers, ['ps']) : 9,
        Kendala: findIndexByCandidates(headers, ['kendala']) >= 0 ? findIndexByCandidates(headers, ['kendala']) : 10
      };

      // render main table header fixed (as required)
      document.querySelector('#mainTable thead tr').innerHTML = `
        <th>Teknisi</th><th>AO</th><th>MO</th><th>Survey</th><th>Tarik DC</th><th>BAI</th><th>PS</th><th>Kendala</th><th>SISA WO</th>
      `;

      // build body
      mainTbody.innerHTML = '';
      const totals = {AO:0, MO:0, Survey:0, Tarik:0, BAI:0, PS:0, Kendala:0, Sisa:0};
      for (const r of bodyRows){
        while (r.length < 13) r.push('');
        const teknisi = r[idx.Teknisi] || '';
        const AO = parseNumber(r[idx.AO]);
        const MO = parseNumber(r[idx.MO]);
        const Survey = parseNumber(r[idx.Survey]);
        const Tarik = parseNumber(r[idx.Tarik]);
        const BAI = parseNumber(r[idx.BAI]);
        const PS = parseNumber(r[idx.PS]);
        const Kendala = parseNumber(r[idx.Kendala]);
        const Sisa = AO + MO + Survey + Tarik + BAI - PS + Kendala;

        totals.AO += AO; totals.MO += MO; totals.Survey += Survey; totals.Tarik += Tarik;
        totals.BAI += BAI; totals.PS += PS; totals.Kendala += Kendala; totals.Sisa += Sisa;

        const tr = document.createElement('tr');

        const cells = [
          {text:teknisi, cls:'' , role:'teknisi'},
          {text:AO, cls:'clickable', status:'AO'},
          {text:MO, cls:'clickable', status:'MO'},
          {text:Survey, cls:'clickable', status:'SURVEY'},
          {text:Tarik, cls:'clickable', status:'TARIK DC'},
          {text:BAI, cls:'clickable', status:'BAI'},
          {text:PS, cls:'clickable', status:'PS'},
          {text:Kendala, cls:'clickable', status:'KENDALA'},
          {text:Sisa, cls:'sisa clickable', status:'SISA WO'}
        ];

        cells.forEach((c, i) => {
          const td = document.createElement('td');
          td.textContent = c.text;
          if (c.cls) td.className = c.cls;
          // attach both teknisi and status so click filters by both
          if (c.status){
            td.dataset.status = c.status;
            td.dataset.teknisi = teknisi;
            td.addEventListener('click', ()=> handleStatusClick(c.status, teknisi));
          }
          tr.appendChild(td);
        });

        mainTbody.appendChild(tr);
      }

      // render totals footer (single row)
      mainTfoot.innerHTML = '';
      const trf = document.createElement('tr');
      trf.innerHTML = `
        <td><strong>TOTAL</strong></td>
        <td><strong>${totals.AO}</strong></td>
        <td><strong>${totals.MO}</strong></td>
        <td><strong>${totals.Survey}</strong></td>
        <td><strong>${totals.Tarik}</strong></td>
        <td><strong>${totals.BAI}</strong></td>
        <td><strong>${totals.PS}</strong></td>
        <td><strong>${totals.Kendala}</strong></td>
        <td class="sisa"><strong>${totals.Sisa}</strong></td>
      `;
      mainTfoot.appendChild(trf);

      // render numeric cards
      renderSummaryCards(totals);

      // cache provi and hide detail
      cacheProvi = dataProvi;
      detailContainer.style.display = 'none';

    }catch(err){
      console.error(err);
      showError('Gagal load data: ' + (err.message || err));
    }finally{
      hideLoading();
    }
  }

  // Filter Provi by status + teknisi (if provided)
  function handleStatusClick(status, teknisi){
    if (!cacheProvi || cacheProvi.length === 0){
      showError('Data detail tidak tersedia. Tekan Refresh.');
      return;
    }
    const headers = cacheProvi[0] || [];
    const rows = cacheProvi.slice(1);
    // find status column index heuristically
    const statusIdx = findIndexByCandidates(headers, ['status','status wo','status_wo','status_wo (h)']);
    const idx = statusIdx >= 0 ? statusIdx : 7; // fallback

    const result = rows.filter(r => {
      const val = (r[idx]||'').toString().trim().toUpperCase();
      // status filter
      let matchStatus = false;
      if (status === 'KENDALA') matchStatus = ['KENDALA JARINGAN','KENDALA PELANGGAN'].includes(val);
      else if (status === 'SISA WO') matchStatus = !['PS','BAI','KENDALA JARINGAN','KENDALA PELANGGAN'].includes(val);
      else matchStatus = val === status;
      if (!matchStatus) return false;
      // teknisi filter if provided
      if (teknisi) {
        // find a column likely to contain teknisi in Provi sheet: check common names
        const teknisiIdx = findIndexByCandidates(headers, ['teknisi','nama teknisi','pic','assigned to','petugas','engineer','teknisi']);
        if (teknisiIdx >= 0) {
          const tval = (r[teknisiIdx]||'').toString().trim();
          return tval === teknisi;
        }
        // fallback: if no teknisi column, return true (can't filter by teknisi)
        return true;
      }
      return true;
    });

    detailThead.innerHTML = '<tr>' + headers.map(h => `<th>${h||''}</th>`).join('') + '</tr>';
    detailTbody.innerHTML = result.map(r => `<tr>${r.map(c=>`<td>${c||''}</td>`).join('')}</tr>`).join('');
    detailContainer.style.display = result.length ? 'block' : 'none';
    detailContainer.scrollIntoView({behavior:'smooth', block:'start'});
  }

  // flexible search across detail table
  function applySearch(q){
    const t = q.trim().toLowerCase();
    if (!t){
      Array.from(detailTbody.querySelectorAll('tr')).forEach(tr => tr.style.display = '');
      return;
    }
    Array.from(detailTbody.querySelectorAll('tr')).forEach(tr => {
      tr.style.display = tr.textContent.toLowerCase().includes(t) ? '' : 'none';
    });
  }

  // init
  (function init(){
    document.getElementById('refreshBtn').addEventListener('click', ()=> loadMainTable());
    document.getElementById('searchDetail').addEventListener('input', e => {
      clearTimeout(window._searchTimer);
      window._searchTimer = setTimeout(()=> applySearch(e.target.value), 180);
    });

    // load PapaParse
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js';
    s.onload = async ()=> {
      try{
        await loadMainTable();
        if (autoRefreshTimer) clearInterval(autoRefreshTimer);
        autoRefreshTimer = setInterval(()=> loadMainTable(), AUTO_REFRESH_MS);
      }catch(e){
        showError('Inisialisasi gagal: ' + (e.message || e));
      }
    };
    s.onerror = ()=> showError('Gagal load PapaParse. Periksa koneksi.');
    document.body.appendChild(s);

    // cleanup auto-refresh on unload
    window.addEventListener('beforeunload', ()=> { if (autoRefreshTimer) clearInterval(autoRefreshTimer); });
  })();
  </script>
</body>
</html>
