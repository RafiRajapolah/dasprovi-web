<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Singaparna</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#0a4275;
      --accent:#145dbf;
      --muted:#f4f6f8;
      --card:#ffffff;
      --shadow: 0 6px 20px rgba(10,66,117,0.08);
    }
    *{box-sizing:border-box}
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      display: flex;
      background: var(--muted);
      transition: all 0.3s ease;
      color:#223;
      min-height:100vh;
    }

    .menu-btn {
      position: fixed;
      top: 15px;
      left: 15px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      cursor: pointer;
      font-size: 18px;
      z-index: 1001;
      transition: background 0.3s;
      box-shadow: var(--shadow);
    }
    .menu-btn:hover{background:var(--accent)}

    .sidebar {
      width: 240px;
      background-color: var(--primary);
      color: white;
      height: 100vh;
      position: fixed;
      left: -240px;
      top: 0;
      display: flex;
      flex-direction: column;
      padding-top: 70px;
      transition: left 0.28s ease;
      z-index: 1000;
    }
    .sidebar.active{left:0}
    .sidebar h2{ text-align:center; font-size:18px; margin-bottom:12px }
    .sidebar a{ color:white; text-decoration:none; padding:12px 20px; display:block }
    .sidebar a.active, .sidebar a:hover{ background:var(--accent); border-left:4px solid #fff }

    .content{
      flex:1;
      margin: 0 auto;
      padding: 24px;
      padding-left: 80px;
      max-width: 1200px;
      width:100%;
      transition: margin-left 0.3s ease;
    }

    header.row{
      display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:18px;
    }
    h1{ margin:0; font-size:20px }

    .card{ background:var(--card); border-radius:12px; padding:14px; box-shadow:var(--shadow); }
    table { width:100%; border-collapse:collapse; overflow:hidden; border-radius:8px }
    thead th{ text-align:center; padding:10px 8px; background:linear-gradient(180deg,var(--accent),var(--primary)); color:#fff; font-size:12px; text-transform:uppercase }
    tbody td{ padding:8px; border-bottom:1px solid #eee; text-align:center; font-size:13px }
    tbody tr:hover{ background:#f7fbff }
    td.clickable{ color:var(--accent); cursor:pointer; font-weight:600 }

    #detailContainer{ margin-top:18px; max-height:420px; overflow:auto; transition:all .3s; opacity:1 }

    .overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.6); z-index:2000; visibility:hidden; opacity:0; transition:all .2s }
    .overlay.active{ visibility:visible; opacity:1 }
    .spinner{ width:64px; height:64px; border-radius:50%; border:6px solid rgba(10,66,117,0.12); border-top-color:var(--primary); animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .controls{ display:flex; gap:8px; align-items:center }
    .controls input[type=text]{ padding:8px 10px; border-radius:8px; border:1px solid #ddd; min-width:220px }
    .controls button{ padding:8px 10px; border-radius:8px; border:0; background:var(--primary); color:white; cursor:pointer }

    /* Accordion style untuk Detail Data */
    details summary {
      cursor: pointer;
      background: #f1f5fb;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 6px;
      font-weight: 600;
      transition: all .2s ease;
    }
    details[open] summary {
      background: #e0edff;
    }
    .inner-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }
    .inner-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #ddd;
      font-size: 12px;
      text-align: left;
    }

    @media (max-width:900px){ .sidebar{width:200px} .menu-btn{left:10px} .content{padding-left:16px} }
    @media (max-width:600px){ thead th{ font-size:11px } tbody td{ font-size:12px } .controls input[type=text]{ min-width:120px } }
  </style>
</head>
<body>
  <button class="menu-btn" id="menuBtn">‚ò∞</button>

  <div class="sidebar" id="sidebar">
    <h2>üìä Dashboard</h2>
    <a href="#" class="active">üè† Das Provi</a>
    <a href="provi_spa.html">üìã Provi SPA</a>
    <a href="monet.html">üí∞ Monet</a>
  </div>

  <div class="content">
    <div class="row header">
      <h1>Dashboard Provisioning</h1>
      <div class="controls">
        <input id="searchDetail" type="text" placeholder="Cari di detail (ketik bebas)..." />
        <button id="refreshBtn">üîÑ Refresh</button>
      </div>
    </div>

    <div class="card" id="mainCard">
      <table id="mainTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="detailContainer" class="card" style="display:none">
      <h2 style="color:var(--accent); margin-top:0">Detail Data</h2>
      <table id="detailTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <div class="overlay" id="overlay"><div class="spinner"></div></div>

  <script>
  const SHEET_MAIN = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQlp8lhcVisWxG9C5IwSDAtyJ1J9o5WwJWAiLMLutD7XI-G6VRh4IipiVkJQnFHXtigs9m2JhKaBD9B/pub?gid=1651389267&single=true&output=csv";
  const SHEET_PROVI = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQlp8lhcVisWxG9C5IwSDAtyJ1J9o5WwJWAiLMLutD7XI-G6VRh4IipiVkJQnFHXtigs9m2JhKaBD9B/pub?gid=1451848426&single=true&output=csv";
  const AUTO_REFRESH_MS = 60000;
  let cacheMain=null, cacheProvi=null, timer=null;

  function $(x){return document.querySelector(x)}
  const overlay=$('#overlay');
  function showLoading(){overlay.classList.add('active')}
  function hideLoading(){overlay.classList.remove('active')}

  async function fetchCSV(url){
    const res=await fetch(url,{cache:'no-store'});
    if(!res.ok)throw new Error("Gagal memuat data");
    const text=await res.text();
    return Papa.parse(text.trim(),{header:false,skipEmptyLines:true}).data;
  }

  async function loadMainTable(){
    showLoading();
    const [main,provi]=await Promise.all([fetchCSV(SHEET_MAIN),fetchCSV(SHEET_PROVI)]);
    cacheMain=main; cacheProvi=provi;
    const rows=main.slice(2,18).map(r=>r.slice(2,13));
    const headers=rows[0]; const body=rows.slice(1);
    const thead=$('#mainTable thead'), tbody=$('#mainTable tbody');
    thead.innerHTML='<tr>'+headers.map(h=>`<th>${h||''}</th>`).join('')+'</tr>';
    tbody.innerHTML='';

    body.forEach(r=>{
      const tr=document.createElement('tr');
      r.forEach((val,i)=>{
        const td=document.createElement('td');
        td.textContent=val;
        const map={5:'SURVEY',6:'TARIK DC',7:'SUDAH SC',8:'PS',9:'KENDALA'};
        if(map[i]){
          td.classList.add('clickable');
          td.dataset.status=map[i];
          td.addEventListener('click',()=>handleStatusClick(map[i]));
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    hideLoading();
  }

  function handleStatusClick(status){
    if(!cacheProvi){alert('Data belum siap');return;}
    showDetail(status);
  }

  function showDetail(status){
    const data=cacheProvi;
    const headers=data[0]; const rows=data.slice(1);
    const STATUS_INDEX=7; const TEKNISI_INDEX=2;
    const t=s=>String(s||'').trim().toUpperCase();
    let filtered=[];
    switch(status){
      case'SURVEY':case'TARIK DC':case'SUDAH SC':case'PS':filtered=rows.filter(r=>t(r[STATUS_INDEX])===status);break;
      case'KENDALA':filtered=rows.filter(r=>['KENDALA JARINGAN','KENDALA PELANGGAN'].includes(t(r[STATUS_INDEX])));break;
      default:filtered=[];
    }

    const groups={};
    filtered.forEach(r=>{
      const tech=r[TEKNISI_INDEX]||'TIDAK DIKETAHUI';
      if(!groups[tech])groups[tech]=[];
      groups[tech].push(r);
    });

    const container=$('#detailContainer'), thead=$('#detailTable thead'), tbody=$('#detailTable tbody');
    thead.innerHTML=''; tbody.innerHTML='';
    tbody.innerHTML=Object.entries(groups).map(([tech,list])=>`
      <tr><td colspan="${headers.length}">
        <details>
          <summary><b>${tech}</b> (${list.length} data)</summary>
          <table class="inner-table">
            ${list.map(r=>`<tr>${r.map(c=>`<td>${c||''}</td>`).join('')}</tr>`).join('')}
          </table>
        </details>
      </td></tr>
    `).join('');
    container.style.display='block';
    container.scrollIntoView({behavior:'smooth'});
  }

  $('#menuBtn').onclick=()=>$('#sidebar').classList.toggle('active');
  $('#refreshBtn').onclick=()=>loadMainTable();

  const papa=document.createElement('script');
  papa.src='https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js';
  papa.onload=()=>{loadMainTable(); timer=setInterval(loadMainTable,AUTO_REFRESH_MS);}
  document.body.appendChild(papa);
  </script>
</body>
</html>
