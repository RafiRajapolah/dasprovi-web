<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DAS PROVI â€” Final Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f4f7fb; --card:#fff; --primary:#0a58a6; --accent:#007bff; --muted:#6b7280;
      --radius:12px; --shadow: 0 10px 30px rgba(12,40,80,0.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Poppins,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#121827}
    .container{max-width:1200px;margin:18px auto;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    .search{display:flex;align-items:center;background:#f5f7fb;border-radius:10px;padding:6px 8px}
    .search input{border:0;background:transparent;outline:none;padding:6px 8px;min-width:220px}
    button.btn{background:var(--primary);color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    .error{display:none;background:#fff4f6;color:#b91c1c;padding:10px;border-radius:8px;margin-bottom:8px}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
    .table-wrap{overflow:auto;border-radius:8px}
    table{width:100%;border-collapse:collapse;min-width:900px}
    thead th{position:sticky;top:0;padding:10px 8px;background:linear-gradient(180deg,var(--accent),var(--primary));color:#fff;text-transform:uppercase;font-size:12px}
    tbody td{padding:10px 8px;border-bottom:1px solid #eef2f7;text-align:center;font-size:13px}
    tbody tr:hover{background:#f7fbff}
    td.clickable{color:var(--accent);cursor:pointer;font-weight:600}
    td.sisa{background:linear-gradient(90deg,rgba(0,123,255,0.06),transparent);color:var(--accent);font-weight:700}
    tfoot td{padding:10px 8px;border-top:2px solid #e6eefc;font-weight:700;text-align:center}
    #detailContainer{margin-top:12px;display:none}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(10,20,40,0.18);visibility:hidden;opacity:0;transition:all .18s;z-index:9999}
    .overlay.active{visibility:visible;opacity:1}
    .spinner{width:56px;height:56px;border-radius:50%;border:6px solid rgba(255,255,255,0.16);border-top-color:#fff;animation:spin 1s linear infinite;background:var(--primary);padding:6px}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:900px){.search input{min-width:140px}table{min-width:700px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <div>
        <h1>DAS PROVI â€” Dashboard Final</h1>
        <div style="color:var(--muted);font-size:13px">SISA WO dihitung: AO + MO + Survey + Tarik DC + BAI - PS + Kendala</div>
      </div>
      <div class="controls">
        <div class="search" title="Search detail">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:.8"><path d="M21 21l-4.35-4.35" stroke="#6b7280" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="searchDetail" placeholder="Cari di detail (ketik bebas)..." aria-label="search" />
        </div>
        <button id="refreshBtn" class="btn">ðŸ”„ Refresh</button>
      </div>
    </div>

    <div id="errorBox" class="error" role="alert"></div>

    <div class="card table-wrap" aria-live="polite">
      <table id="mainTable" role="table" aria-label="Tabel Sisa WO">
        <thead><tr>
          <th>Teknisi</th>
          <th>AO</th>
          <th>MO</th>
          <th>Survey</th>
          <th>Tarik DC</th>
          <th>BAI</th>
          <th>PS</th>
          <th>Kendala</th>
          <th>SISA WO</th>
        </tr></thead>
        <tbody></tbody>
        <tfoot></tfoot>
      </table>
    </div>

    <div id="detailContainer" class="card" aria-live="polite">
      <h3 style="margin-top:0;color:var(--primary)">Detail Data</h3>
      <div style="overflow:auto;max-height:360px">
        <table id="detailTable"><thead></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay"><div class="spinner" role="status" aria-label="loading"></div></div>

  <script>
  // ================== CONFIG ==================
  const SHEET_MAIN = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQlp8lhcVisWxG9C5IwSDAtyJ1J9o5WwJWAiLMLutD7XI-G6VRh4IipiVkJQnFHXtigs9m2JhKaBD9B/pub?gid=1651389267&single=true&output=csv";
  const SHEET_PROVI = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQlp8lhcVisWxG9C5IwSDAtyJ1J9o5WwJWAiLMLutD7XI-G6VRh4IipiVkJQnFHXtigs9m2JhKaBD9B/pub?gid=1451848426&single=true&output=csv";
  const AUTO_REFRESH_MS = 60 * 1000; // 1 minute
  const FETCH_TIMEOUT_MS = 15000; // 15s

  // ================== STATE ==================
  let cacheMain = null;
  let cacheProvi = null;
  let autoRefreshTimer = null;

  const overlay = document.getElementById('overlay');
  const errorBox = document.getElementById('errorBox');
  const mainTbody = document.querySelector('#mainTable tbody');
  const mainTfoot = document.querySelector('#mainTable tfoot');
  const detailContainer = document.getElementById('detailContainer');
  const detailThead = document.querySelector('#detailTable thead');
  const detailTbody = document.querySelector('#detailTable tbody');

  function showLoading(){ overlay.classList.add('active') }
  function hideLoading(){ overlay.classList.remove('active') }
  function showError(msg){ errorBox.style.display='block'; errorBox.textContent = msg }
  function clearError(){ errorBox.style.display='none'; errorBox.textContent = '' }

  function parseNumber(v){
    if (v === null || v === undefined) return 0;
    const s = String(v).replace(/[^0-9.-]+/g,'');
    // careful digit-by-digit: use parseFloat on cleaned string
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }

  // Fetch with timeout and fallback proxy (helps when remote blocks CORS)
  async function fetchWithTimeout(url, opts = {}){
    const controller = new AbortController();
    const id = setTimeout(()=> controller.abort(), FETCH_TIMEOUT_MS);
    try{
      const r = await fetch(url, { signal: controller.signal, ...opts });
      clearTimeout(id);
      return r;
    }catch(err){
      clearTimeout(id);
      throw err;
    }
  }

  async function fetchCSV(url){
    if (typeof navigator !== 'undefined' && !navigator.onLine) throw new Error('Offline: periksa koneksi internet.');
    // try direct
    try{
      const res = await fetchWithTimeout(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      return Papa.parse(text.trim(), { header: false, skipEmptyLines: true }).data;
    }catch(err){
      // fallback to public proxy
      try{
        const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
        const res2 = await fetchWithTimeout(proxy, { cache: 'no-store' });
        if (!res2.ok) throw new Error('Proxy HTTP ' + res2.status);
        const text2 = await res2.text();
        return Papa.parse(text2.trim(), { header: false, skipEmptyLines: true }).data;
      }catch(proxyErr){
        throw new Error('Gagal unduh CSV. Pastikan Google Sheet sudah \"Publish to web\" (CSV) dan dapat diakses. Details: ' + (proxyErr.message || proxyErr));
      }
    }
  }

  // Helper: try find column index by header candidates (case-insensitive)
  function findIndexByCandidates(headers, candidates){
    if (!headers) return -1;
    const lower = headers.map(h => (h||'').toString().toLowerCase());
    for (const cand of candidates){
      const lc = cand.toLowerCase();
      for (let i=0;i<lower.length;i++){
        if (lower[i].includes(lc) || lc.includes(lower[i])) return i;
      }
    }
    return -1;
  }

  // Compute SISA WO as requested
  function computeSisaWOFromRow(row, idxMap){
    // idxMap maps field -> index in row
    const AO = parseNumber(row[idxMap.AO]);
    const MO = parseNumber(row[idxMap.MO]);
    const Survey = parseNumber(row[idxMap.Survey]);
    const Tarik = parseNumber(row[idxMap.Tarik]);
    const BAI = parseNumber(row[idxMap.BAI]);
    const PS = parseNumber(row[idxMap.PS]);
    const Kendala = parseNumber(row[idxMap.Kendala]);
    // SISA WO = AO + MO + Survey + Tarik DC + BAI - PS + Kendala
    return AO + MO + Survey + Tarik + BAI - PS + Kendala;
  }

  // Render main table using mapped columns derived from CSV headers or fallback positions
  async function loadMainTable(){
    clearError();
    showLoading();
    try{
      if (typeof Papa === 'undefined') throw new Error('Library PapaParse belum dimuat.');
      const [dataMain, dataProvi] = await Promise.all([fetchCSV(SHEET_MAIN), fetchCSV(SHEET_PROVI)]);
      cacheMain = dataMain;
      cacheProvi = dataProvi;

      // Try to get the area we used before: use rows 3..18 (index 2..17) and columns C..M (slice 2..13) if sheet is in that structure
      const rawRows = cacheMain.slice(2, 18); // keep original rows
      const slicedRows = rawRows.map(r => r.slice(2, 13)); // C..M
      if (!slicedRows || slicedRows.length === 0) throw new Error('CSV utama kosong atau format tidak sesuai.');

      const headers = slicedRows[0].map(h => h || '');
      const bodyRows = slicedRows.slice(1);

      // Attempt to detect indices by header names (robust)
      // Candidate names
      const idxMap = {
        Teknisi: findIndexByCandidates(headers, ['teknisi','nama teknisi','nama']),
        AO: findIndexByCandidates(headers, ['ao','a.o']),
        MO: findIndexByCandidates(headers, ['mo']),
        Survey: findIndexByCandidates(headers, ['survey']),
        Tarik: findIndexByCandidates(headers, ['tarik dc','tarik_dc','tarik']),
        BAI: findIndexByCandidates(headers, ['bai']),
        PS: findIndexByCandidates(headers, ['ps']),
        Kendala: findIndexByCandidates(headers, ['kendala'])
      };

      // If detection failed for any, fallback to default positions used previously (relative to slice):
      // Default mapping (based on earlier code expectations): Teknisi=0, AO=1, MO=2, Survey=5, Tarik=6, BAI=7, PS=9, Kendala=10
      const fallback = {Teknisi:0, AO:1, MO:2, Survey:5, Tarik:6, BAI:7, PS:9, Kendala:10};
      for (const k of Object.keys(idxMap)){
        if (idxMap[k] === -1) idxMap[k] = fallback[k];
      }

      // If we used fallback for any index, warn user (non-blocking)
      const usedFallback = Object.keys(idxMap).filter(k => idxMap[k] === fallback[k]);
      if (usedFallback.length > 0){
        // don't spam, show subtle message
        showError('Beberapa kolom tidak terdeteksi otomatis; menggunakan asumsi posisi default. Jika hasil salah, periksa header CSV atau kirim urutan kolom.');
        // hide after 8s
        setTimeout(clearError, 8000);
      }

      // Build table: header row explicit (Teknisi, AO, MO, Survey, Tarik DC, BAI, PS, Kendala, SISA WO)
      const theadRow = ['Teknisi','AO','MO','Survey','Tarik DC','BAI','PS','Kendala','SISA WO'];
      const thead = document.querySelector('#mainTable thead tr');
      thead.innerHTML = theadRow.map(h => `<th>${h}</th>`).join('');

      // Render body
      mainTbody.innerHTML = '';
      const totals = {AO:0, MO:0, Survey:0, Tarik:0, BAI:0, PS:0, Kendala:0, Sisa:0};
      for (const r of bodyRows){
        // Ensure length
        while (r.length < 12) r.push('');
        const tr = document.createElement('tr');

        const teknisi = r[idxMap.Teknisi] || '';
        const AO = parseNumber(r[idxMap.AO]);
        const MO = parseNumber(r[idxMap.MO]);
        const Survey = parseNumber(r[idxMap.Survey]);
        const Tarik = parseNumber(r[idxMap.Tarik]);
        const BAI = parseNumber(r[idxMap.BAI]);
        const PS = parseNumber(r[idxMap.PS]);
        const Kendala = parseNumber(r[idxMap.Kendala]);
        const Sisa = AO + MO + Survey + Tarik + BAI - PS + Kendala;

        // accumulate totals
        totals.AO += AO; totals.MO += MO; totals.Survey += Survey; totals.Tarik += Tarik;
        totals.BAI += BAI; totals.PS += PS; totals.Kendala += Kendala; totals.Sisa += Sisa;

        // Cells: render in order
        const cells = [
          {text:teknisi, cls:''},
          {text:AO, cls:''},
          {text:MO, cls:''},
          {text:Survey, cls:'clickable', status:'SURVEY'},
          {text:Tarik, cls:'clickable', status:'TARIK DC'},
          {text:BAI, cls:''},
          {text:PS, cls:'clickable', status:'PS'},
          {text:Kendala, cls:'clickable', status:'KENDALA'},
          {text:Sisa, cls:'sisa clickable', status:'SISA WO'}
        ];

        cells.forEach((c, i)=>{
          const td = document.createElement('td');
          td.textContent = c.text;
          if (c.cls) td.className = c.cls;
          // attach click for status cells to show detail using cacheProvi
          if (c.status){
            td.dataset.status = c.status;
            td.addEventListener('click', ()=> handleStatusClick(c.status));
          }
          tr.appendChild(td);
        });

        mainTbody.appendChild(tr);
      }

      // Render single TOTAL row in tfoot
      mainTfoot.innerHTML = '';
      const trow = document.createElement('tr');
      trow.innerHTML = `
        <td><strong>TOTAL</strong></td>
        <td><strong>${totals.AO}</strong></td>
        <td><strong>${totals.MO}</strong></td>
        <td><strong>${totals.Survey}</strong></td>
        <td><strong>${totals.Tarik}</strong></td>
        <td><strong>${totals.BAI}</strong></td>
        <td><strong>${totals.PS}</strong></td>
        <td><strong>${totals.Kendala}</strong></td>
        <td class="sisa"><strong>${totals.Sisa}</strong></td>
      `;
      mainTfoot.appendChild(trow);

      // Save cacheProvi for detail filtering
      cacheProvi = dataProvi;

      // hide detail if open
      detailContainer.style.display = 'none';
    }catch(err){
      console.error(err);
      showError('Gagal load data: ' + (err.message || err));
    }finally{
      hideLoading();
    }
  }

  // Handle clicking a status cell: filter Provi sheet by status text
  function handleStatusClick(status){
    if (!cacheProvi || cacheProvi.length === 0){
      showError('Data detail tidak tersedia. Tekan Refresh.');
      setTimeout(clearError, 5000);
      return;
    }
    // detect header index for status in Provi sheet
    const proviHeaders = cacheProvi[0] || [];
    // try find likely status column: "status", "status wo", "status_wo"
    const statusIdx = findIndexByCandidates(proviHeaders, ['status','status_wo','status wo','status wo (h)','status_wo']);
    // fallback: use index 7 as earlier code did
    const idx = statusIdx >= 0 ? statusIdx : 7;

    const rows = cacheProvi.slice(1).filter(r => {
      const val = (r[idx] || '').toString().trim().toUpperCase();
      if (status === 'KENDALA') return ['KENDALA JARINGAN','KENDALA PELANGGAN'].includes(val);
      if (status === 'SISA WO') {
        return !['PS','BAI','KENDALA JARINGAN','KENDALA PELANGGAN'].includes(val);
      }
      return val === status;
    });

    // Render detail table
    detailThead.innerHTML = '<tr>' + (proviHeaders.map(h => `<th>${h||''}</th>`).join('')) + '</tr>';
    detailTbody.innerHTML = rows.map(r => `<tr>${r.map(c=>`<td>${c||''}</td>`).join('')}</tr>`).join('');
    detailContainer.style.display = rows.length ? 'block' : 'none';
    // scroll into view
    detailContainer.scrollIntoView({behavior:'smooth', block:'start'});
  }

  // Flexible search across detail table
  function applySearch(q){
    const t = q.trim().toLowerCase();
    if (!t){
      Array.from(detailTbody.querySelectorAll('tr')).forEach(tr => tr.style.display = '');
      return;
    }
    Array.from(detailTbody.querySelectorAll('tr')).forEach(tr => {
      tr.style.display = tr.textContent.toLowerCase().includes(t) ? '' : 'none';
    });
  }

  // init: load PapaParse then table
  (function init(){
    // wire UI
    document.getElementById('refreshBtn').addEventListener('click', ()=> loadMainTable());
    document.getElementById('searchDetail').addEventListener('input', e => {
      clearTimeout(window._searchTimer);
      window._searchTimer = setTimeout(()=> applySearch(e.target.value), 180);
    });

    // load PapaParse lib
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js';
    s.onload = async ()=> {
      try{
        await loadMainTable();
        // start auto-refresh
        if (autoRefreshTimer) clearInterval(autoRefreshTimer);
        autoRefreshTimer = setInterval(()=> loadMainTable(), AUTO_REFRESH_MS);
      }catch(e){
        showError('Inisialisasi gagal: ' + (e.message || e));
      }
    };
    s.onerror = ()=> showError('Gagal load PapaParse. Periksa koneksi.');
    document.body.appendChild(s);

    // cleanup
    window.addEventListener('beforeunload', ()=> { if (autoRefreshTimer) clearInterval(autoRefreshTimer); });
  })();
  </script>
</body>
</html>

