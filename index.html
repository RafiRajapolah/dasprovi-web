<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Provi</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#007bff;
      --bg:#f8f9fa;
    }
    body{
      font-family:'Poppins',sans-serif;
      background:var(--bg);
      margin:0;
      padding:0;
      color:#333;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-bottom:20px;
    }
    th,td{
      border:1px solid #ccc;
      padding:6px 8px;
      text-align:center;
      font-size:14px;
    }
    th{
      background:#e9ecef;
      font-weight:600;
    }
    .clickable{
      color:var(--primary);
      font-weight:600;
      cursor:pointer;
      transition:all .2s;
    }
    .clickable:hover{
      background:var(--primary);
      color:#fff;
    }
    #detailContainer{
      display:none;
      padding:10px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .loading{
      position:fixed;
      inset:0;
      background:rgba(255,255,255,.8);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      font-weight:600;
      color:var(--primary);
      z-index:999;
    }
  </style>
</head>
<body>
  <div id="loading" class="loading" style="display:none;">Loading...</div>
  <div style="padding:20px;">
    <h2>ðŸ“Š Dashboard Provi</h2>
    <table id="mainTable">
      <thead></thead>
      <tbody></tbody>
    </table>
    <div id="detailContainer">
      <h3 id="detailTitle">Detail Data</h3>
      <table id="detailTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
  const SHEET_MAIN = "https://docs.google.com/spreadsheets/d/e/2PACX-1vYOUR_SHEET_MAIN/pub?gid=0&single=true&output=csv";
  const SHEET_PROVI = "https://docs.google.com/spreadsheets/d/e/2PACX-1vYOUR_SHEET_PROVI/pub?gid=0&single=true&output=csv";

  let cacheMain = [];
  let cacheProvi = [];

  const $ = (sel)=>document.querySelector(sel);
  const showLoading = ()=>$('#loading').style.display='flex';
  const hideLoading = ()=>$('#loading').style.display='none';
  const parseNumber = (v)=>parseFloat((v||'').toString().replace(',','.'))||0;

  async function fetchCSV(url){
    const res = await fetch(url);
    const text = await res.text();
    return text.split(/\r?\n/).map(r=>r.split(','));
  }

  async function loadMainTable(){
    try{
      showLoading();
      const [dataMain, dataProvi] = await Promise.all([fetchCSV(SHEET_MAIN), fetchCSV(SHEET_PROVI)]);
      cacheMain = dataMain;
      cacheProvi = dataProvi;

      const rows = cacheMain.slice(2, 18).map(r => r.slice(2, 13));
      const headers = rows[0] || [];
      const bodyRows = rows.slice(1);

      const thead = $('#mainTable thead');
      const tbody = $('#mainTable tbody');
      thead.innerHTML = '<tr>' + headers.map(h => `<th>${h || ''}</th>`).join('') + '</tr>';
      tbody.innerHTML = '';

      bodyRows.forEach((row)=>{
        while(row.length < 12) row.push('');
        const tr = document.createElement('tr');
        const teknisiName = row[0];

        row.forEach((val, colIndex)=>{
          const td = document.createElement('td');
          td.textContent = (val === '' || val === null || val === undefined) ? '' : val;

          const statusMap = { 
            5:'SURVEY', 
            6:'TARIK DC', 
            7:'BAI', 
            8:'PS', 
            9:'KENDALA', 
            10:'SISA WO' 
          };

          // Tambahkan event click hanya untuk kolom status
          if (!isNaN(parseNumber(val)) && statusMap[colIndex]){
            td.classList.add('clickable');
            td.dataset.status = statusMap[colIndex];
            td.dataset.teknisi = teknisiName;
            td.addEventListener('click',(e)=>{
              handleStatusClick(
                e.currentTarget.dataset.status,
                e.currentTarget.dataset.teknisi
              );
            });
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

    }catch(err){
      console.error(err);
      alert('Terjadi kesalahan saat load data: ' + (err.message || err));
    }finally{
      hideLoading();
    }
  }

  function handleStatusClick(status, teknisi){
    if (!cacheProvi){ 
      alert('Data detail belum siap, coba refresh.'); 
      return; 
    }
    showDetail(status, teknisi);
  }

  function showDetail(status, teknisi){
    const data = cacheProvi;
    if (!data || data.length === 0) return;
    const headers = data[0];
    const rows = data.slice(1);

    const STATUS_WO_INDEX = 7;   // kolom status
    const NAMA_TEKNISI_INDEX = 4; // sesuaikan dengan CSV kamu

    const t = (s)=> (s||'').toString().trim().toUpperCase();
    const teknisiUpper = (teknisi || '').toString().trim().toUpperCase();

    let filtered = [];

    // Jika klik baris total, teknisi kosong â†’ tampilkan semua teknisi
    const isTotalRow = teknisiUpper === 'TOTAL' || teknisiUpper === '';

    switch(status){
      case 'SURVEY':
      case 'TARIK DC':
      case 'BAI':
      case 'PS':
        filtered = rows.filter(r => 
          t(r[STATUS_WO_INDEX]) === status && (isTotalRow || t(r[NAMA_TEKNISI_INDEX]) === teknisiUpper)
        );
        break;
      case 'KENDALA':
        filtered = rows.filter(r => 
          ['KENDALA JARINGAN','KENDALA PELANGGAN'].includes(t(r[STATUS_WO_INDEX])) &&
          (isTotalRow || t(r[NAMA_TEKNISI_INDEX]) === teknisiUpper)
        );
        break;
      case 'SISA WO':
        filtered = rows.filter(r => 
          !['PS','BAI','KENDALA JARINGAN','KENDALA PELANGGAN'].includes(t(r[STATUS_WO_INDEX])) &&
          (isTotalRow || t(r[NAMA_TEKNISI_INDEX]) === teknisiUpper)
        );
        break;
    }

    const container = $('#detailContainer');
    const thead = $('#detailTable thead');
    const tbody = $('#detailTable tbody');
    const title = $('#detailTitle');

    title.textContent = isTotalRow 
      ? `Detail Semua ${status}` 
      : `Detail ${status} - ${teknisi}`;

    thead.innerHTML = '<tr>' + (headers || []).map(h => `<th>${h||''}</th>`).join('') + '</tr>';
    tbody.innerHTML = filtered.map(r => `<tr>${r.map(c=>`<td>${c||''}</td>`).join('')}</tr>`).join('');

    container.style.display = filtered.length ? 'block' : 'none';
    container.scrollIntoView({ behavior:'smooth', block:'start' });
  }

  // Jalankan saat halaman dibuka
  loadMainTable();
  </script>
</body>
</html>
